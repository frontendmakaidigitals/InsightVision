name: Deploy Next.js App - Production
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy to Production
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_EMAIL_USER: ${{ secrets.NEXT_PUBLIC_EMAIL_USER }}
      NEXT_PUBLIC_EMAIL_PASS: ${{ secrets.NEXT_PUBLIC_EMAIL_PASS }}
      NEXT_PUBLIC_EMAIL_TO: ${{ secrets.NEXT_PUBLIC_EMAIL_TO }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Cache Next.js build
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-prod-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-prod-${{ hashFiles('**/package-lock.json') }}-

      - name: Build project
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/ 2>/dev/null || true
          cp package.json package-lock.json deploy/
          cp next.config.* deploy/ 2>/dev/null || true
          cp -r app deploy/ 2>/dev/null || true
          cp -r components deploy/ 2>/dev/null || true
          cp -r lib deploy/ 2>/dev/null || true
          cp -r config deploy/ 2>/dev/null || true
          cp -r hooks deploy/ 2>/dev/null || true
          cp -r styles deploy/ 2>/dev/null || true
          cp -r types deploy/ 2>/dev/null || true
          cp -r utils deploy/ 2>/dev/null || true
          cp tailwind.config.* deploy/ 2>/dev/null || true
          cp postcss.config.* deploy/ 2>/dev/null || true
          cp tsconfig.json deploy/ 2>/dev/null || true
          cd deploy && tar -czf ../insightvision-deploy.tar.gz .

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: insightvision-build
          path: insightvision-deploy.tar.gz

      - name: Copy build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "insightvision-deploy.tar.gz"
          target: "/home/${{ secrets.SSH_USER }}/"

      - name: Deploy and restart
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # Navigate to app directory
            cd /home/${{ secrets.SSH_USER }}/insightvision
            
            # Create backup of existing .next
            if [ -d ".next" ]; then
              mv .next .next.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # Extract the deployment package
            tar -xzf /home/${{ secrets.SSH_USER }}/insightvision-deploy.tar.gz -C .
            
            # Verify package.json exists
            if [ ! -f "package.json" ]; then
              echo "‚ùå Error: package.json not found after extraction"
              ls -la
              exit 1
            fi
            
            # Install production dependencies
            npm ci --omit=dev
            
            # Verify .next directory exists
            if [ ! -d ".next" ]; then
              echo "‚ùå Error: .next directory not found"
              exit 1
            fi
            
            # Kill process on port 3002
            PORT=3002
            PID=$(lsof -t -i:$PORT 2>/dev/null) || true
            if [ ! -z "$PID" ]; then
              echo "Killing process on port $PORT (PID: $PID)"
              kill -9 $PID
            fi
            
            # Restart with PM2
            pm2 delete insightvision || true
            PORT=3002 pm2 start npm --name "insightvision" -- start
            pm2 save
            
            # Cleanup
            rm -f /home/${{ secrets.SSH_USER }}/insightvision-deploy.tar.gz
            
            # Wait for application to start
            sleep 10
            
            echo "‚úÖ Deployment completed"
            pm2 list

      - name: Health check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # Check if the application is responding
            for i in {1..5}; do
              if curl -f http://localhost:3002 > /dev/null 2>&1; then
                echo "‚úÖ Application is healthy"
                pm2 list
                exit 0
              fi
              echo "‚è≥ Attempt $i: Waiting for application..."
              sleep 10
            done
            echo "‚ùå Application health check failed"
            pm2 logs insightvision --lines 50
            exit 1

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "üîÑ Deployment failed, attempting rollback..."
            cd /home/${{ secrets.SSH_USER }}/insightvision
            
            # Find latest backup
            BACKUP=$(ls -t .next.backup.* 2>/dev/null | head -n1)
            if [ -n "$BACKUP" ]; then
              echo "üì¶ Restoring from backup: $BACKUP"
              rm -rf .next
              mv "$BACKUP" .next
              pm2 restart insightvision
              echo "‚úÖ Rollback completed"
            else
              echo "‚ùå No backup found for rollback"
              pm2 restart insightvision
            fi